# nhm-windshaft-app

This nodejs application provides clustered instances of the [Windshaft](https://github.com/CartoDB/Windshaft) server, tailored for serving tiles to the [Ckan map extension](https://github.com/NaturalHistoryMuseum/ckanext-map).

**Warning**: The server should not be publicly available. It does not serve tiles to the client but to the CKan extension, and exposes internal components!

- The URL for tiles is '/database/:database_name/table/:table_name. Note that while this can serve tiles from different databases/tables, the geom field must be same across (see *Configuration*);
- Typically requests will also include an ```sql``` GET parameter (defining the SQL query) and a ```style``` parameter (defining the [CartoCSS](https://www.mapbox.com/carto/api/2.3.0/) style). Note that those are generated by the Ckan extension directly;
- The SQL may use Mapnik markers (!pixel_width!, !bbox!, etc.);
- The style may use the following placeholders:
  - !markers!: Refers to the directory containing markers on the windshaft server;
- Starting the application will spawn a number of workers (see *Configuration*), which can be set to restart after a number of requests. Sending a SIGHUP to the main process will cause all the workers to be restarted one by one, ensuring there are always some workers available - this is useful for providing code updates without downtime.


## Configuration
In config.js you must define the following:

- ```windshaft_port```: Port on which the windshaft application will be listening;
- ```postgres_host```: The Host for the postgres database;
- ```postgres_port```: The port for the postgres database;
- ```postgres_user```: The postgres username (**read only!**);
- ```postgres_pass```: The postgres password;
- ```geometry_field```: The geometry field. This cannot be configured per request, and must be constant. The default on the Ckan plugin in '_the_geom_webmercator';
- ```num_workers```: The number of workers to run. If the application is CPU bound, then this should be equal to the number of CPUs and no more;
- ```worker_max_requests```: The maximum number of requests a worker will server. When reached the worker will be closed and a new one spawned. Set to 0 to disable this feature.
